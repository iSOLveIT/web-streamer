const socket=io('/meeting');const desktopSendBtn=document.getElementById('desktop_send_btn');const mobileSendBtn=document.getElementById('mobile_send_btn');const hostDesktopLeaveBtn=document.getElementById('host_desktop_leave_btn');const hostMobileLeaveBtn=document.getElementById('host_mobile_leave_btn');const studentDesktopLeaveBtn=document.getElementById('viewer_desktop_leave_btn');const studentMobileLeaveBtn=document.getElementById('viewer_mobile_leave_btn');socket.on('connect',()=>{socket.emit('join-room',{room_id:ROOM_ID,user_id:USER_ID,user_name:USERNAME});});socket.on('add_member',data=>{let users_counts=document.querySelectorAll(".users_counts");let member_spaces=document.querySelectorAll(".member-space");member_spaces[0].innerHTML+=add_member_desktop(data);member_spaces[1].innerHTML+=add_member_mobile(data);users_counts.forEach(function(user_count){user_count.textContent=parseInt(user_count.textContent)+1;})});socket.on('add_members',data=>{let users_counts=document.querySelectorAll(".users_counts");let member_spaces=document.querySelectorAll(".member-space");let participants=data;for(i in participants){member_spaces[0].innerHTML+=add_member_desktop(participants[i]);member_spaces[1].innerHTML+=add_member_mobile(participants[i]);}
users_counts.forEach(function(user_count){user_count.textContent=participants.length;})});socket.on('remove_member',data=>{let member_spaces=document.querySelectorAll(".member-space p, .member-space hr");for(member=0;member<member_spaces.length;member++){if(member_spaces[member].textContent==`${data}`){member_spaces[member].remove();member_spaces[parseInt(member+1)].remove();}}
if(isMobile==true){let mobile_members=document.querySelectorAll(".participants_feature .member-space p");let users_counts=document.querySelector("#users_btn span.users_counts");users_counts.textContent=mobile_members.length;}
else{let desktop_members=document.querySelectorAll("li.dropdown .member-space p");let users_counts=document.querySelector("span.bg-counter.users_counts");users_counts.textContent=desktop_members.length;}});socket.on('server_response',data=>{console.log(data.result);});socket.on('class_end',()=>{window.localStorage.setItem("v_hours",0);window.localStorage.setItem("v_minutes",0);window.localStorage.setItem("v_seconds",0);window.localStorage.removeItem("v_hours");window.localStorage.removeItem("v_minutes");window.localStorage.removeItem("v_seconds");let notice=document.querySelectorAll(".message");let data="Class ended by Host";if(!0===isMobile){let item=notice[1];item.innerHTML=data;item.classList.add("info-notice");item.classList.remove("message");item.style.display="block";setTimeout((function(){window.location.replace("/join_meeting/v/user_verify")}),3e3)}else{let item=notice[0];item.innerHTML=data;item.classList.add("info-notice");item.classList.remove("message");item.style.display="block";setTimeout((function(){window.location.replace("/join_meeting/v/user_verify")}),3e3)}})
socket.on('room_notice',data=>{let notice=document.querySelectorAll(".message");let isHandheldDevice=/iPhone|iPad|iPod|Android/.test(navigator.userAgent);if(isHandheldDevice==true){let item=notice[1];item.innerHTML=data;item.classList.add('info-notice');item.classList.remove('message');item.style.display="block";}
else{let item=notice[0];item.innerHTML=data;item.classList.add('info-notice');item.classList.remove('message');item.style.display="block";}});function ringtone(){const CHAT_RINGTONE=document.getElementById("ringtone");CHAT_RINGTONE.play();}
socket.on('receive_room_message',data=>{let roomMsgBox=document.querySelectorAll(".chat-space");roomMsgBox.forEach(function(room_box){let paragraph=user_msg(data.sender,data.msg,chatSentAt());room_box.innerHTML+=paragraph;})
ringtone();});desktopSendBtn.addEventListener('click',function(){let roomMsgBox=document.querySelectorAll(".chat-space");let msg=document.querySelector('.desktop_msg_area').value;let isEmpty=/^[\n\t\ ]*?$/.test(msg);let isQuestion=document.getElementById("desktop_question_check");if(isEmpty!=true){if(isQuestion!=null&&isQuestion.checked==true){msg=`✋ ${msg}`;roomMsgBox.forEach(function(room_box){let paragraph=host_msg(msg,chatSentAt());room_box.innerHTML+=paragraph;})
broadcast_msg(msg);document.querySelector('.desktop_msg_area').value="";document.getElementById("desktop_question_check").checked=false;}
else{roomMsgBox.forEach(function(room_box){let paragraph=host_msg(msg,chatSentAt());room_box.innerHTML+=paragraph;})
broadcast_msg(msg);document.querySelector('.desktop_msg_area').value="";}}})
mobileSendBtn.addEventListener('click',function(){let roomMsgBox=document.querySelectorAll(".chat-space");let msg=document.querySelector('.mobile_msg_area').value;let isEmpty=/^[\n\t\ ]*?$/.test(msg);let isQuestion=document.getElementById("mobile_question_check");if(isEmpty!=true){if(isQuestion!=null&&isQuestion.checked==true){msg=`✋ ${msg}`;roomMsgBox.forEach(function(room_box){let paragraph=host_msg(msg,chatSentAt());room_box.innerHTML+=paragraph;})
broadcast_msg(msg);document.querySelector('.mobile_msg_area').value="";document.getElementById("mobile_question_check").checked=false;}
else{roomMsgBox.forEach(function(room_box){let paragraph=host_msg(msg,chatSentAt());room_box.innerHTML+=paragraph;})
broadcast_msg(msg);document.querySelector('.mobile_msg_area').value="";}}})
var student_leave=function(){window.localStorage.setItem("v_hours",0);window.localStorage.setItem("v_minutes",0);window.localStorage.setItem("v_seconds",0);window.localStorage.removeItem("v_hours");window.localStorage.removeItem("v_minutes");window.localStorage.removeItem("v_seconds");leave_room();window.location.replace("/join_meeting/v/user_verify");}
var host_leave=function(){socket.emit('notice',{room_id:ROOM_ID,msg:"Class ended by Host"});window.localStorage.setItem("s_hours",0);window.localStorage.setItem("s_minutes",0);window.localStorage.setItem("s_seconds",0);window.localStorage.removeItem("s_hours");window.localStorage.removeItem("s_minutes");window.localStorage.removeItem("s_seconds");close_room();window.location.replace(`/attendance_report/${ROOM_ID}`);}
if(studentDesktopLeaveBtn!=null||studentMobileLeaveBtn!=null){studentDesktopLeaveBtn.addEventListener('click',function(){student_leave()});studentMobileLeaveBtn.addEventListener('click',function(){student_leave()});}
if(hostDesktopLeaveBtn!=null||hostMobileLeaveBtn!=null){hostDesktopLeaveBtn.addEventListener('click',function(){host_leave()});hostMobileLeaveBtn.addEventListener('click',function(){host_leave()});}
function broadcast_msg(message){socket.emit('send_room_message',{room_id:ROOM_ID,msg:`${message}`,sender:USERNAME});}
function leave_room(){socket.emit('leave-room',{room_id:ROOM_ID,user_id:USER_ID});}
function close_room(){socket.emit('close-room',{room_id:ROOM_ID,user_id:USER_ID});}
function host_msg(message,time_sent){return`<p class="fw-normal p-2 host-message mt-2"> <b>You</b> @ <em>${time_sent}</em><br>${message}</p>`}
function user_msg(sender,message,time_sent){return`<p class="fw-normal p-2 member-message mt-2"> <b>${sender}</b> @ <em>${time_sent}</em><br>${message}</p>`}
function add_member_mobile(member_id){return"<p class=\"fw-bold p-2\">"+`${member_id}`+"</p><hr>"}
function add_member_desktop(member_id){return" <p class=\"dropdown-item\">"+`${member_id}`+"</p><hr class=\"dropdown-divider\">"}
function chatSentAt(){var date=new Date();var hours=date.getHours();var minutes=date.getMinutes();var new_format=hours>=12?'pm':'am';hours=hours%12;hours=hours?hours:12;minutes=minutes<10?'0'+minutes:minutes;let result=hours+':'+minutes+' '+new_format;return result}
